<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DigiKipp – Schauen & Merken</title>
  
  <!-- Web App Manifest -->
  <link rel="manifest" href="manifest.json">
  
  <!-- iOS Meta Tags -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="DigiKipp">
  <link rel="apple-touch-icon" href="icon-192.png">
  
  <!-- Theme Color -->
  <meta name="theme-color" content="#1a0f0a">

  <style>
    :root{
      --cols: 8;
      --cell: 142px;
      --grid-alpha: 0.05;

      --violett: rgb(164, 27, 133);
      --blau:    rgb(0, 107, 179);
      --gruen:   rgb(0, 166, 82);
      --orange:  rgb(249, 150, 30);

      --colorSize: 126px;

      --bg-off-x: 4px;
      --bg-off-y: 5px;

      --scale: 1;
      --uiscale: 1;
      --gridW: calc(var(--cols) * var(--cell));
      --gridH: 100vh;

      --ui-panel-bg: #2a1810;
      --ui-text: #ffd700;
      --btn-bg: linear-gradient(135deg, #ff6b35 0%, #ff8c42 100%);
      --btn-text: #ffffff;
      --btn-border: rgba(255, 215, 0, 0.5);
      --slot-border: rgba(255, 215, 0, 0.8);
      --slot-border-w: 3px;

      /* Würfel-Farben - Mahagoni/Luxus */
      --cube-wood-base: #8B4513;
      --cube-wood-deep: #5C2E0F;
      --cube-wood-warm: rgba(139, 69, 19, 0.9);
      --cube-wood-gold: rgba(255, 215, 0, 0.15);
      --w1-innerframe: rgba(255, 215, 0, 0.6);
      --slot-fill: #6B3410;

      --rotSign: 1;
      --rot: 0deg;

      /* Header-Skalierung */
      --headerScale: 0.75;

      /* CLIP: Schatten nur im Innenraum 2B–7G sichtbar */
      --clipTop:    calc((2 - 1) * var(--cell));
      --clipLeft:   calc((2 - 1) * var(--cell));
      --clipRight:  calc((8 - 7) * var(--cell));
      --clipBottom: calc(var(--gridH) - (7 * var(--cell)));
    }

    html, body{
      height: 100%;
      margin: 0;
      overflow: hidden;
      font-family: 'Georgia', 'Times New Roman', serif;
      touch-action: manipulation;
    }

    /* Funkelnder Sternen-Hintergrund */
    @keyframes twinkle {
      0%, 100% { opacity: 0.3; }
      50% { opacity: 1; }
    }

    @keyframes float {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-10px); }
    }

    body{
      background: 
        radial-gradient(2px 2px at 20% 30%, white, transparent),
        radial-gradient(2px 2px at 60% 70%, white, transparent),
        radial-gradient(1px 1px at 50% 50%, white, transparent),
        radial-gradient(1px 1px at 80% 10%, white, transparent),
        radial-gradient(2px 2px at 90% 60%, white, transparent),
        radial-gradient(1px 1px at 33% 50%, white, transparent),
        radial-gradient(1px 1px at 15% 80%, white, transparent),
        linear-gradient(135deg, #0a0505 0%, #1a0f0a 50%, #0f0a05 100%);
      background-size: 
        200% 200%,
        200% 200%,
        200% 200%,
        200% 200%,
        200% 200%,
        200% 200%,
        200% 200%,
        100% 100%;
      animation: twinkle 3s ease-in-out infinite;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      position: relative;
    }

    /* Zusätzliche funkelnde Sterne */
    body::before {
      content: '';
      position: absolute;
      width: 100%;
      height: 100%;
      background-image: 
        radial-gradient(circle at 10% 20%, rgba(255, 215, 0, 0.3) 0%, transparent 2%),
        radial-gradient(circle at 90% 80%, rgba(255, 215, 0, 0.2) 0%, transparent 2%),
        radial-gradient(circle at 50% 10%, rgba(255, 255, 255, 0.4) 0%, transparent 1%),
        radial-gradient(circle at 30% 90%, rgba(255, 255, 255, 0.3) 0%, transparent 1%),
        radial-gradient(circle at 70% 40%, rgba(255, 215, 0, 0.25) 0%, transparent 2%);
      animation: twinkle 4s ease-in-out infinite reverse;
      pointer-events: none;
    }

    .stage{
      width: 100vw;
      height: 100vh;
      position: relative;
      overflow: hidden;
    }

    .layout{
      position: absolute;
      left: 50%;
      top: 0;
      width: var(--gridW);
      height: var(--gridH);
      transform-origin: top center;
      transform: translateX(-50%) scale(var(--scale));
    }

    /* Goldener Rahmen um das Spielfeld */
    .layout::before {
      content: '';
      position: absolute;
      left: calc(1 * var(--cell) - 12px);
      top: calc(1 * var(--cell) - 12px);
      width: calc(6 * var(--cell) + 24px);
      height: calc(6 * var(--cell) + 24px);
      border: 8px solid;
      border-image: linear-gradient(135deg, 
        #FFD700 0%, 
        #FFA500 25%, 
        #FFD700 50%, 
        #FF8C00 75%, 
        #FFD700 100%) 1;
      box-shadow: 
        0 0 20px rgba(255, 215, 0, 0.6),
        inset 0 0 20px rgba(255, 215, 0, 0.3),
        0 0 40px rgba(255, 165, 0, 0.4);
      pointer-events: none;
      z-index: 15;
      animation: goldenGlow 3s ease-in-out infinite;
    }

    @keyframes goldenGlow {
      0%, 100% { 
        box-shadow: 
          0 0 20px rgba(255, 215, 0, 0.6),
          inset 0 0 20px rgba(255, 215, 0, 0.3),
          0 0 40px rgba(255, 165, 0, 0.4);
      }
      50% { 
        box-shadow: 
          0 0 30px rgba(255, 215, 0, 0.8),
          inset 0 0 30px rgba(255, 215, 0, 0.5),
          0 0 60px rgba(255, 165, 0, 0.6);
      }
    }

    /* Z-INDEX: 0 - Box Hintergrund */
    .bgPNG{
      position:absolute;
      left: 0;
      top: 0;
      width: var(--gridW);
      height: var(--gridH);
      background: 
        radial-gradient(ellipse at center, rgba(139, 69, 19, 0.3), transparent 70%),
        linear-gradient(135deg, #3d2314 0%, #5c3420 50%, #3d2314 100%);
      background-repeat: no-repeat;
      background-size: 100% auto;
      background-position:
        calc(0px + var(--bg-off-x))
        calc(0px + var(--bg-off-y));
      pointer-events: none;
      z-index: 0;
    }

    /* Z-INDEX: 1 - Kugel mit Glanz */
    .ball{
      position: absolute;
      left: calc(4 * var(--cell));
      top: calc((4 + 2) * var(--cell));
      width: calc(var(--cell) * 0.55);
      height: calc(var(--cell) * 0.55);
      border-radius: 50%;
      transform: translate(-50%, -50%);
      background:
        radial-gradient(circle at 30% 25%, rgba(255, 255, 255, 0.9), rgba(255, 255, 255, 0.0) 40%),
        radial-gradient(circle at 55% 60%, rgba(0, 0, 0, 0.3), rgba(0, 0, 0, 0.00) 55%),
        radial-gradient(circle at 50% 55%, #d4af37, #8B6914 70%);
      box-shadow: 
        0 8px 20px rgba(0, 0, 0, 0.5),
        inset 0 2px 5px rgba(255, 215, 0, 0.4);
      z-index: 1;
      pointer-events: none;
    }

    .colors{
      position:absolute;
      left: 0;
      top: 0;
      width: var(--gridW);
      height: var(--gridH);
      pointer-events: none;
      z-index: 1;
    }

    /* Glitzernde Farbquadrate mit Animation */
    @keyframes sparkle {
      0%, 100% {
        box-shadow: 
          0 0 10px currentColor,
          inset 0 0 15px rgba(255, 255, 255, 0.3);
      }
      50% {
        box-shadow: 
          0 0 25px currentColor,
          inset 0 0 25px rgba(255, 255, 255, 0.6);
      }
    }

    @keyframes shimmer {
      0% { background-position: -100% 0; }
      100% { background-position: 200% 0; }
    }

    .colorSq{
      position:absolute;
      width: var(--colorSize);
      height: var(--colorSize);
      border-radius: 8px;
      animation: sparkle 2s ease-in-out infinite;
      position: relative;
      overflow: hidden;
    }

    /* Glitzer-Overlay für alle Farben */
    .colorSq::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: linear-gradient(
        45deg,
        transparent 30%,
        rgba(255, 255, 255, 0.5) 50%,
        transparent 70%
      );
      animation: shimmer 3s linear infinite;
    }

    .c-gruen   { 
      background: linear-gradient(135deg, var(--gruen) 0%, #00cc66 100%);
      color: var(--gruen);
    }
    .c-orange  { 
      background: linear-gradient(135deg, var(--orange) 0%, #ffaa44 100%);
      color: var(--orange);
    }
    .c-blau    { 
      background: linear-gradient(135deg, var(--blau) 0%, #0088cc 100%);
      color: var(--blau);
    }
    .c-violett { 
      background: linear-gradient(135deg, var(--violett) 0%, #cc2299 100%);
      color: var(--violett);
    }

    /* Würfel-Schatten (clip 2B–7G) */
    .cubeShadowLayer{
      position: absolute;
      left: 0;
      top: 0;
      width: var(--gridW);
      height: var(--gridH);
      z-index: 2;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.15s ease;

      --pivot-x: calc(4 * var(--cell));
      --pivot-y: calc((4 + 2) * var(--cell));

      transform:
        translate(var(--pivot-x), var(--pivot-y))
        rotate(var(--rot))
        translate(calc(-1 * var(--pivot-x)), calc(-1 * var(--pivot-y)));
      transform-origin: 0 0;
    }
    .cubeShadowLayer.visible{ opacity: 1; }

    .cubeShadowClip{
      position:absolute;
      inset:0;
      pointer-events:none;
      clip-path: inset(var(--clipTop) var(--clipRight) var(--clipBottom) var(--clipLeft));
    }

    .cubeShadowInner{
      position: absolute;
      left: calc(1 * var(--cell));
      top:  calc((1 + 2) * var(--cell));
      width: calc(3 * var(--cell));
      height: calc(3 * var(--cell));
      background: transparent;
      border-radius: 10px;
      box-shadow:
        18px 26px 34px rgba(0, 0, 0, 0.5),
        26px 38px 54px rgba(0, 0, 0, 0.4),
        34px 50px 78px rgba(0, 0, 0, 0.3);
    }

    .grid{
      position:absolute;
      left: 0;
      top: 0;
      width: var(--gridW);
      height: var(--gridH);
      z-index: 2;
      pointer-events: none;
      background-image:
        repeating-linear-gradient(
          to right,
          rgba(255, 215, 0, var(--grid-alpha)) 0px,
          rgba(255, 215, 0, var(--grid-alpha)) 1px,
          rgba(255, 215, 0, 0) 1px,
          rgba(255, 215, 0, 0) var(--cell)
        ),
        repeating-linear-gradient(
          to bottom,
          rgba(255, 215, 0, var(--grid-alpha)) 0px,
          rgba(255, 215, 0, var(--grid-alpha)) 1px,
          rgba(255, 215, 0, 0) 1px,
          rgba(255, 215, 0, 0) var(--cell)
        );
    }

    /* Zwischenkipp-Schatten PNGs */
    .zwischenKippSchattenLayer{
      position: absolute;
      left: 0;
      top: 0;
      width: var(--gridW);
      height: var(--gridH);
      z-index: 3;
      pointer-events: none;
    }

    .zwischenKippSchatten{
      position: absolute;
      left: calc(1 * var(--cell));
      top: calc(3 * var(--cell));
      width: calc(6 * var(--cell));
      height: calc(6 * var(--cell));
      background-size: 100% 100%;
      background-repeat: no-repeat;
      background-position: 0 0;
      opacity: 0;
      transition: opacity 0.1s ease;
    }
    .zwischenKippSchatten.visible{ opacity: 1; }

    #shadowQ0{ background-image: url("SchattenZwischenKipp_Q0.png"); }
    #shadowQ1{ background-image: url("SchattenZwischenKipp_Q1.png"); }
    #shadowQ2{ background-image: url("SchattenZwischenKipp_Q2.png"); }
    #shadowQ3{ background-image: url("SchattenZwischenKipp_Q3.png"); }

    /* Würfel Groups mit Mahagoni-Effekt */
    .wFaceGroup,
    .kipGroup{
      position: absolute;
      left: 0;
      top: 0;
      width: var(--gridW);
      height: var(--gridH);
      z-index: 4;
      pointer-events: none;

      --pivot-x: calc(4 * var(--cell));
      --pivot-y: calc((4 + 2) * var(--cell));

      transform:
        translate(var(--pivot-x), var(--pivot-y))
        rotate(var(--rot))
        translate(calc(-1 * var(--pivot-x)), calc(-1 * var(--pivot-y)));
      transform-origin: 0 0;
    }

    .wFaceGroup.hidden,
    .kipGroup.hidden{
      display: none;
    }

    /* W1 – Holzfläche mit Mahagoni-Maserung */
    .w1{
      position:absolute;
      left: calc(1 * var(--cell));
      top:  calc(3 * var(--cell));
      width: calc(3 * var(--cell));
      height: calc(3 * var(--cell));
      border-radius: 12px;
      background:
        linear-gradient(135deg, 
          transparent 0%, 
          var(--cube-wood-gold) 50%, 
          transparent 100%
        ),
        repeating-linear-gradient(
          90deg,
          var(--cube-wood-base) 0px,
          var(--cube-wood-base) 8px,
          var(--cube-wood-deep) 8px,
          var(--cube-wood-deep) 16px
        ),
        linear-gradient(180deg, var(--cube-wood-base), var(--cube-wood-deep));
      box-shadow:
        inset 0 2px 8px rgba(255, 215, 0, 0.2),
        inset 0 -2px 8px rgba(0, 0, 0, 0.4),
        0 8px 20px rgba(0, 0, 0, 0.4);
      border: 3px solid var(--w1-innerframe);
    }

    /* Zahlenplättchen mit goldenem Glanz */
    .num{
      position:absolute;
      width: var(--cell);
      height: var(--cell);
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 6px;
      background:
        radial-gradient(circle at 30% 30%, rgba(255, 255, 255, 0.4), transparent 60%),
        linear-gradient(135deg, #f5e6d3 0%, #d9c3a8 100%);
      box-shadow:
        inset 0 2px 4px rgba(255, 255, 255, 0.5),
        inset 0 -2px 4px rgba(0, 0, 0, 0.2),
        0 4px 8px rgba(0, 0, 0, 0.3);
      font-size: calc(var(--cell) * 0.6);
      font-weight: 900;
      color: #2a1810;
      text-shadow: 
        1px 1px 2px rgba(255, 255, 255, 0.8),
        -1px -1px 2px rgba(0, 0, 0, 0.2);
      border: 2px solid rgba(139, 69, 19, 0.4);
    }

    /* UI Panels mit Premium-Design */
    .uipanel{
      position:absolute;
      width: 100%;
      pointer-events: none;
      z-index: 20;
    }
    .uipanel > *{
      pointer-events: auto;
    }

    .btn{
      padding: 12px 28px;
      font-size: 18px;
      font-weight: bold;
      border: 3px solid var(--btn-border);
      border-radius: 12px;
      background: var(--btn-bg);
      color: var(--btn-text);
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 
        0 4px 15px rgba(255, 165, 0, 0.4),
        inset 0 1px 3px rgba(255, 255, 255, 0.3);
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      font-family: 'Georgia', serif;
    }
    .btn:active{
      transform: scale(0.95);
      box-shadow: 
        0 2px 8px rgba(255, 165, 0, 0.6),
        inset 0 1px 3px rgba(0, 0, 0, 0.3);
    }
    .btn:hover{
      box-shadow: 
        0 6px 20px rgba(255, 165, 0, 0.6),
        inset 0 1px 3px rgba(255, 255, 255, 0.5);
      transform: translateY(-2px);
    }

    #titleLeft{
      position:absolute;
      font-size: calc(var(--cell) * 0.58);
      font-weight: 900;
      color: var(--ui-text);
      text-shadow: 
        0 0 20px rgba(255, 215, 0, 0.8),
        0 0 40px rgba(255, 165, 0, 0.6),
        3px 3px 6px rgba(0, 0, 0, 0.8);
      letter-spacing: 0.05em;
      font-family: 'Georgia', serif;
      pointer-events: none;
      z-index: 25;
    }

    #scoreRun{
      position:absolute;
      font-size: calc(var(--cell) * 0.56);
      font-weight: 900;
      color: var(--ui-text);
      text-shadow: 
        0 0 15px rgba(255, 215, 0, 0.9),
        0 0 30px rgba(255, 165, 0, 0.7),
        2px 2px 4px rgba(0, 0, 0, 0.8);
      transform: translate(-50%, -50%);
      pointer-events: none;
      z-index: 25;
    }

    #scoreDisplay{
      position:absolute;
      font-size: calc(var(--cell) * 0.96);
      font-weight: 900;
      color: var(--ui-text);
      text-shadow: 
        0 0 20px rgba(255, 215, 0, 1),
        0 0 40px rgba(255, 165, 0, 0.8),
        3px 3px 6px rgba(0, 0, 0, 0.9);
      transform: translate(-50%, -50%);
      opacity: 0;
      transition: opacity 0.3s ease;
      pointer-events: none;
      z-index: 25;
    }
    #scoreDisplay.finalVisible{
      opacity: 1;
    }

    @keyframes scorePulse{
      0%, 100%{
        transform: translate(-50%, -50%) scale(1);
        text-shadow: 
          0 0 20px rgba(255, 215, 0, 1),
          0 0 40px rgba(255, 165, 0, 0.8),
          3px 3px 6px rgba(0, 0, 0, 0.9);
      }
      50%{
        transform: translate(-50%, -50%) scale(1.15);
        text-shadow: 
          0 0 30px rgba(255, 215, 0, 1),
          0 0 60px rgba(255, 165, 0, 1),
          3px 3px 8px rgba(0, 0, 0, 0.9);
      }
    }
    #scoreDisplay.scorePulse{
      animation: scorePulse 0.6s ease 3;
    }

    #hintTitle{
      position:absolute;
      left: 50%;
      transform: translateX(-50%);
      font-size: calc(var(--cell) * 0.32);
      font-weight: bold;
      color: var(--ui-text);
      text-align: center;
      text-shadow: 
        0 0 10px rgba(255, 215, 0, 0.8),
        0 0 20px rgba(255, 165, 0, 0.5),
        2px 2px 4px rgba(0, 0, 0, 0.8);
      pointer-events: none;
      z-index: 20;
      font-family: 'Georgia', serif;
    }

    #kippAnzahlBtns{
      position:absolute;
      display: flex;
      gap: 16px;
      justify-content: center;
      pointer-events: auto;
      z-index: 20;
    }
    #kippAnzahlBtns.hidden{
      display: none !important;
    }

    #startBtnWrap{
      position:absolute;
      left: 50%;
      transform: translateX(-50%) scale(var(--uiscale));
      z-index: 20;
      display: flex;
      justify-content: center;
    }
    #startBtnWrap.hidden{
      display: none !important;
    }

    #targetPadBtn{
      position:absolute;
      background: 
        radial-gradient(circle at 30% 30%, rgba(255, 255, 255, 0.2), transparent 70%),
        linear-gradient(135deg, rgba(139, 69, 19, 0.8), rgba(92, 46, 15, 0.9));
      border: 4px solid rgba(255, 215, 0, 0.6);
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: calc(var(--cell) * 0.4);
      font-weight: bold;
      color: var(--ui-text);
      text-shadow: 
        0 0 10px rgba(255, 215, 0, 0.8),
        2px 2px 4px rgba(0, 0, 0, 0.8);
      cursor: pointer;
      pointer-events: auto;
      box-shadow: 
        0 8px 20px rgba(0, 0, 0, 0.5),
        inset 0 2px 5px rgba(255, 215, 0, 0.3);
      z-index: 21;
      transition: all 0.3s ease;
    }
    #targetPadBtn:active{
      transform: scale(0.96);
      box-shadow: 
        0 4px 12px rgba(0, 0, 0, 0.6),
        inset 0 2px 5px rgba(0, 0, 0, 0.4);
    }
    #targetPadBtn:hover{
      border-color: rgba(255, 215, 0, 0.9);
      box-shadow: 
        0 10px 25px rgba(255, 165, 0, 0.5),
        inset 0 2px 5px rgba(255, 215, 0, 0.5);
    }
    #targetPadBtn.hidden{
      display: none !important;
    }

    .backArrow{
      position:absolute;
      width: calc(var(--cell) * var(--headerScale));
      height: calc(var(--cell) * var(--headerScale));
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: calc(var(--cell) * 0.48 * var(--headerScale));
      font-weight: bold;
      color: var(--ui-text);
      text-shadow: 
        0 0 10px rgba(255, 215, 0, 0.8),
        2px 2px 4px rgba(0, 0, 0, 0.8);
      cursor: pointer;
      pointer-events: auto;
      z-index: 25;
      transition: all 0.3s ease;
    }
    .backArrow:active{
      transform: translate(-50%, -50%) scale(0.9);
    }
    .backArrow:hover{
      transform: translate(-50%, -50%) scale(1.1);
      text-shadow: 
        0 0 15px rgba(255, 215, 0, 1),
        0 0 30px rgba(255, 165, 0, 0.8),
        2px 2px 4px rgba(0, 0, 0, 0.9);
    }

    #testTargetBtn{
      width: calc(var(--cell) * 0.8);
      height: calc(var(--cell) * 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: calc(var(--cell) * 0.3);
      font-weight: bold;
      background: linear-gradient(135deg, #ff3333, #cc0000);
      color: white;
      border: 3px solid rgba(255, 215, 0, 0.5);
      border-radius: 12px;
      cursor: pointer;
      box-shadow: 
        0 4px 12px rgba(255, 0, 0, 0.4),
        inset 0 1px 3px rgba(255, 255, 255, 0.3);
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
      transition: all 0.3s ease;
    }
    #testTargetBtn:hover{
      transform: translate(-50%, -50%) scale(1.05);
      box-shadow: 
        0 6px 16px rgba(255, 0, 0, 0.6),
        inset 0 1px 3px rgba(255, 255, 255, 0.4);
    }
    #testTargetBtn.hidden{
      display: none !important;
    }

    .kipWrapper{
      position:absolute;
      left: 0;
      top:  calc(3 * var(--cell));
      width: calc(6 * var(--cell));
      height: calc(6 * var(--cell));
      pointer-events: auto;
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      grid-template-rows: repeat(6, 1fr);
      gap: 0;
    }

    .kippCell{
      border: 1px solid rgba(255, 215, 0, 0.15);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background 0.2s ease;
      background: transparent;
    }
    .kippCell:hover{
      background: rgba(255, 215, 0, 0.1);
    }
    .kippCell.taken{
      pointer-events: none;
      background: rgba(0, 0, 0, 0.2);
    }

    .kipTarget{
      position:absolute;
      width: var(--cell);
      height: var(--cell);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: calc(var(--cell) * 0.5);
      font-weight: 900;
      color: transparent;
      pointer-events: none;
      border-radius: 8px;
      background: 
        radial-gradient(circle at 30% 30%, rgba(255, 255, 255, 0.3), transparent 60%),
        linear-gradient(135deg, #8B4513, #5C2E0F);
      box-shadow:
        inset 0 2px 5px rgba(255, 215, 0, 0.2),
        0 4px 12px rgba(0, 0, 0, 0.4);
      border: 2px solid rgba(255, 215, 0, 0.4);
      transition: color 0.3s ease;
    }
    .kipTarget.revealed{
      color: var(--ui-text);
      text-shadow: 
        0 0 8px rgba(255, 215, 0, 0.8),
        0 2px 4px rgba(0, 0, 0, 0.8);
      animation: revealPulse 0.5s ease;
    }

    @keyframes revealPulse{
      0%, 100%{
        transform: scale(1);
      }
      50%{
        transform: scale(1.1);
        box-shadow:
          inset 0 2px 8px rgba(255, 215, 0, 0.4),
          0 6px 20px rgba(255, 215, 0, 0.5);
      }
    }

    /* Intro Overlay mit Premium-Design */
    #introOverlay{
      position: fixed;
      inset: 0;
      background: 
        radial-gradient(circle at center, rgba(0, 0, 0, 0.85), rgba(0, 0, 0, 0.95)),
        linear-gradient(135deg, #0a0505, #1a0f0a);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
      opacity: 1;
      transition: opacity 0.4s ease;
    }
    #introOverlay.hidden{
      opacity: 0;
      pointer-events: none;
    }

    .introTitle{
      font-size: clamp(32px, 8vw, 72px);
      font-weight: 900;
      color: var(--ui-text);
      text-shadow: 
        0 0 30px rgba(255, 215, 0, 1),
        0 0 60px rgba(255, 165, 0, 0.8),
        4px 4px 8px rgba(0, 0, 0, 0.9);
      margin-bottom: 30px;
      text-align: center;
      font-family: 'Georgia', serif;
      letter-spacing: 0.1em;
      animation: float 3s ease-in-out infinite;
    }

    .introSubtitle{
      font-size: clamp(16px, 4vw, 28px);
      font-weight: bold;
      color: rgba(255, 215, 0, 0.9);
      text-shadow: 
        0 0 10px rgba(255, 215, 0, 0.6),
        2px 2px 4px rgba(0, 0, 0, 0.8);
      margin-bottom: 50px;
      text-align: center;
      font-family: 'Georgia', serif;
    }

    .introButtons{
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
      justify-content: center;
    }

    .introBtn{
      padding: 16px 40px;
      font-size: 20px;
      font-weight: bold;
      border: 3px solid var(--btn-border);
      border-radius: 12px;
      background: var(--btn-bg);
      color: var(--btn-text);
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 
        0 6px 20px rgba(255, 165, 0, 0.5),
        inset 0 2px 4px rgba(255, 255, 255, 0.3);
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.4);
      font-family: 'Georgia', serif;
    }
    .introBtn:hover{
      transform: translateY(-3px);
      box-shadow: 
        0 8px 25px rgba(255, 165, 0, 0.7),
        inset 0 2px 4px rgba(255, 255, 255, 0.5);
    }
    .introBtn:active{
      transform: translateY(-1px);
      box-shadow: 
        0 4px 15px rgba(255, 165, 0, 0.8),
        inset 0 2px 4px rgba(0, 0, 0, 0.3);
    }

    .introBtn.secondary{
      background: linear-gradient(135deg, #666, #444);
      border-color: rgba(255, 255, 255, 0.3);
    }
  </style>
</head>
<body>
  <div class="stage">
    <div class="layout">
      <div class="bgPNG"></div>
      <div class="ball"></div>
      <div class="colors"></div>

      <div class="cubeShadowLayer">
        <div class="cubeShadowClip">
          <div class="cubeShadowInner"></div>
        </div>
      </div>

      <div class="grid"></div>

      <div class="zwischenKippSchattenLayer">
        <div id="shadowQ0" class="zwischenKippSchatten"></div>
        <div id="shadowQ1" class="zwischenKippSchatten"></div>
        <div id="shadowQ2" class="zwischenKippSchatten"></div>
        <div id="shadowQ3" class="zwischenKippSchatten"></div>
      </div>

      <!-- Würfel-Gesicht W -->
      <div class="wFaceGroup">
        <div class="w1"></div>
        <div class="numLayer">
          <div id="wn4" class="num"></div>
          <div id="wn7" class="num"></div>
          <div id="wn1" class="num"></div>
          <div id="wn2" class="num"></div>
        </div>
      </div>

      <!-- Kipp-Gesicht -->
      <div class="kipGroup hidden">
        <div class="kipWrapper"></div>
      </div>

      <!-- UI Panels -->
      <div class="uipanel">
        <div id="titleLeft">DIGIKIPP</div>
        <div id="scoreRun">00</div>
        <div id="scoreDisplay">00</div>
        <div id="hintTitle">SCHAUKIPP-RUNDE</div>

        <div id="kippAnzahlBtns" class="hidden">
          <button class="btn" data-anzahl="1">1×</button>
          <button class="btn" data-anzahl="2">2×</button>
          <button class="btn" data-anzahl="3">3×</button>
        </div>

        <div id="startBtnWrap" class="hidden">
          <button id="btnErgebnis" class="btn">SCHAUEN & MERKEN</button>
        </div>

        <div id="targetPadBtn" class="hidden"></div>
        <div id="backBtn" class="backArrow">←</div>
        <div id="testTargetBtn" class="hidden">TEST</div>
      </div>
    </div>
  </div>

  <!-- Intro Overlay -->
  <div id="introOverlay">
    <div class="introTitle">DIGIKIPP</div>
    <div class="introSubtitle">Schauen & Merken</div>
    <div class="introButtons">
      <button id="introStartBtn" class="introBtn">SPIEL STARTEN</button>
      <button id="introBackBtn" class="introBtn secondary">ZURÜCK</button>
    </div>
  </div>

  <script>
    // Konstanten & Koordinaten-System
    const HEADER_ROW_OFFSET = 2;
    const ALPHA = "ABCDEFGH";

    function coordToXY(coord){
      const row = parseInt(coord);
      const colLetter = coord.slice(-1);
      const col = ALPHA.indexOf(colLetter) + 1;
      return { row, col };
    }

    const backBtn = document.getElementById("backBtn");
    const kippAnzahlBtns = document.getElementById("kippAnzahlBtns");
    const startBtnWrap = document.getElementById("startBtnWrap");
    const btnErgebnis = document.getElementById("btnErgebnis");
    const targetPadBtn = document.getElementById("targetPadBtn");
    const hintTitle = document.getElementById("hintTitle");
    const testTargetBtn = document.getElementById("testTargetBtn");

    const wFaceGroup = document.querySelector(".wFaceGroup");
    const kipGroup = document.querySelector(".kipGroup");
    const kipWrapper = document.querySelector(".kipWrapper");
    const colorsEl = document.querySelector(".colors");
    const numLayer = document.querySelector(".numLayer");

    let uiMode = "START";
    let kippAnzahl = 1;

    let wFace = {
      4: { val: 4, coord: "2B" },
      7: { val: 7, coord: "2C" },
      1: { val: 1, coord: "3B" },
      2: { val: 2, coord: "4B" }
    };

    let kipAssignments = [];
    for(let i = 0; i < 36; i++){
      kipAssignments.push(null);
    }

    let preview = {
      dir: null,
      interval: null,
      startT: 0,
      progress: 0
    };

    let rot = 0;
    let colorScheme = "v-o-o-b";

    let targetDeck = [];
    let currentTarget = null;
    let targetRevealed = false;
    let started = false;
    let hitsCount = 0;
    let attemptsForTarget = 0;
    let endRestartMode = false;

    const lockColorForVal = {};
    let lockedPlacements = [];

    function resetLockedColors(){
      for(const k of Object.keys(lockColorForVal)){
        delete lockColorForVal[k];
      }
      lockedPlacements = [];
    }

    // Hilfsfunktionen
    function numVar(name){
      return parseFloat(getComputedStyle(document.documentElement).getPropertyValue(name)) || 0;
    }

    function roll(n){ return Math.floor(Math.random() * n); }

    function randomTarget(){
      const digits = [1,2,4,7];
      const arr = [];
      for(let i=0; i<4; i++){
        arr.push(digits[roll(digits.length)]);
      }
      return arr.join("");
    }

    function resetTargetDeck(){
      targetDeck = [];
      for(let i=0; i<12; i++){
        targetDeck.push(randomTarget());
      }
    }

    function pullTarget(){
      if(targetDeck.length === 0) return null;
      return targetDeck.shift();
    }

    function updateScore(){
      const run = document.getElementById("scoreRun");
      if(run){
        const str = String(hitsCount).padStart(2, "0");
        run.textContent = str;
      }
    }

    function showStartView(){
      uiMode = "START";
      hintTitle.textContent = "SCHAUKIPP-RUNDE";
      kippAnzahlBtns.classList.remove("hidden");
      startBtnWrap.classList.add("hidden");
      targetPadBtn.classList.add("hidden");
      testTargetBtn.classList.add("hidden");
      showW();
      updateShadowVisibility();
    }

    function showCountView(){
      uiMode = "COUNT";
      hintTitle.textContent = "ANZAHL WÄHLEN";
      kippAnzahlBtns.classList.add("hidden");
      startBtnWrap.classList.add("hidden");
      targetPadBtn.classList.add("hidden");
      testTargetBtn.classList.remove("hidden");
      showKip();
      updateShadowVisibility();
    }

    function showTargetView(){
      uiMode = "TARGET";
      targetPadBtn.textContent = "?";
      targetRevealed = false;
      hintTitle.textContent = "KIPP-Richtung wählen";
      kippAnzahlBtns.classList.add("hidden");
      startBtnWrap.classList.add("hidden");
      targetPadBtn.classList.remove("hidden");
      testTargetBtn.classList.add("hidden");
      updateShadowVisibility();
    }

    function showEndView(){
      uiMode = "END";
      endRestartMode = true;

      hintTitle.textContent = "ENDE – Gesamt-Treffer";
      kippAnzahlBtns.classList.add("hidden");
      startBtnWrap.classList.remove("hidden");
      targetPadBtn.classList.add("hidden");
      testTargetBtn.classList.add("hidden");

      const scoreEl = document.getElementById("scoreDisplay");
      if(scoreEl){
        const finalScore = String(hitsCount).padStart(2,"0");
        scoreEl.textContent = finalScore;

        scoreEl.style.removeProperty("opacity");
        scoreEl.classList.add("finalVisible");

        setTimeout(() => {
          scoreEl.classList.add("scorePulse");
        }, 100);
      }

      btnErgebnis.textContent = "NEUSTART";
      btnErgebnis.onclick = () => {
        endRestartMode = false;
        initPlayState();
      };

      showW();
      updateShadowVisibility();
    }

    // Würfel-Rotation
    function rotW(direction){
      if(preview.interval) return;

      const steps = 18;
      const angleStep = 90 / steps;
      const msPerStep = 20;

      preview.dir = direction;
      preview.startT = Date.now();
      preview.progress = 0;

      let step = 0;

      preview.interval = setInterval(() => {
        step++;
        preview.progress = step / steps;

        let sign = 1;
        if(direction === 1){
          sign = 1;
        } else if(direction === 2){
          sign = -1;
        } else if(direction === 3){
          sign = 1;
        } else {
          sign = -1;
        }

        rot += sign * angleStep;
        document.documentElement.style.setProperty("--rot", rot + "deg");

        if(step >= steps){
          clearInterval(preview.interval);
          preview.interval = null;
          preview.dir = null;

          finishRotate(direction);
        }
      }, msPerStep);

      updateShadowVisibility();
    }

    function finishRotate(direction){
      const oldW = {...wFace};
      const newW = {};

      const order = direction === 1 || direction === 3 ? [4,1,2,7] : [7,2,1,4];
      const positions = [[2,"B"],[3,"B"],[4,"B"],[2,"C"]];

      for(let i=0; i<4; i++){
        const wKey = order[i];
        const [r, c] = positions[i];
        const coord = String(r) + c;
        newW[wKey] = { val: oldW[wKey].val, coord };
      }

      wFace = newW;
      renderW();
      updateShadowVisibility();

      // Locked Colors mitdrehen
      let rotatedLocks = [];
      for(const pl of lockedPlacements){
        const [oldCoord, cls] = pl;
        const { row, col } = coordToXY(oldCoord);

        let newRow = row;
        let newCol = col;

        if(direction === 1){
          if(row === 1 && col >= 2 && col <= 7){
            newCol = col + 1;
            if(newCol > 7) newCol = 2;
          } else if(row === 8 && col >= 2 && col <= 7){
            newCol = col - 1;
            if(newCol < 2) newCol = 7;
          } else if(col === 1 && row >= 3 && row <= 6){
            newRow = row - 1;
            if(newRow < 3) newRow = 6;
          } else if(col === 8 && row >= 3 && row <= 6){
            newRow = row + 1;
            if(newRow > 6) newRow = 3;
          }
        } else if(direction === 2){
          if(row === 1 && col >= 2 && col <= 7){
            newCol = col - 1;
            if(newCol < 2) newCol = 7;
          } else if(row === 8 && col >= 2 && col <= 7){
            newCol = col + 1;
            if(newCol > 7) newCol = 2;
          } else if(col === 1 && row >= 3 && row <= 6){
            newRow = row + 1;
            if(newRow > 6) newRow = 3;
          } else if(col === 8 && row >= 3 && row <= 6){
            newRow = row - 1;
            if(newRow < 3) newRow = 6;
          }
        } else if(direction === 3){
          if(col === 1 && row >= 3 && row <= 6){
            newRow = row - 1;
            if(newRow < 3) newRow = 6;
          } else if(col === 8 && row >= 3 && row <= 6){
            newRow = row + 1;
            if(newRow > 6) newRow = 3;
          } else if(row === 1 && col >= 2 && col <= 7){
            newCol = col + 1;
            if(newCol > 7) newCol = 2;
          } else if(row === 8 && col >= 2 && col <= 7){
            newCol = col - 1;
            if(newCol < 2) newCol = 7;
          }
        } else {
          if(col === 1 && row >= 3 && row <= 6){
            newRow = row + 1;
            if(newRow > 6) newRow = 3;
          } else if(col === 8 && row >= 3 && row <= 6){
            newRow = row - 1;
            if(newRow < 3) newRow = 6;
          } else if(row === 1 && col >= 2 && col <= 7){
            newCol = col - 1;
            if(newCol < 2) newCol = 7;
          } else if(row === 8 && col >= 2 && col <= 7){
            newCol = col + 1;
            if(newCol > 7) newCol = 2;
          }
        }

        const newCoord = String(newRow) + ALPHA[newCol - 1];
        rotatedLocks.push([newCoord, cls]);
      }

      lockedPlacements = rotatedLocks;
      for(const wKey of Object.keys(wFace)){
        const val = wFace[wKey].val;
        const oldColor = lockColorForVal[val];
        if(!oldColor) continue;

        const newCoord = wFace[wKey].coord;
        for(let i = 0; i < lockedPlacements.length; i++){
          const [coord, cls] = lockedPlacements[i];
          if(coord === wFace[wKey].coord){
            lockedPlacements[i] = [newCoord, cls];
          }
        }
      }

      rebuildColors();
    }

    function cancelPreview(){
      if(!preview.interval) return;
      clearInterval(preview.interval);
      preview.interval = null;
      preview.dir = null;
    }

    function showW(){
      kipGroup.classList.add("hidden");
      wFaceGroup.classList.remove("hidden");
      updateShadowVisibility();
    }

    function showKip(){
      wFaceGroup.classList.add("hidden");
      kipGroup.classList.remove("hidden");
      updateShadowVisibility();
    }

    function renderW(){
      const cellPx = numVar("--cell") || 142;

      for(const wKey of Object.keys(wFace)){
        const info = wFace[wKey];
        const el = document.getElementById("wn" + wKey);
        if(!el) continue;

        const { row, col } = coordToXY(info.coord);
        const visualRow = row + HEADER_ROW_OFFSET;

        const left = (col - 1) * cellPx;
        const top  = (visualRow - 1) * cellPx;

        el.style.left = left + "px";
        el.style.top  = top + "px";
        el.textContent = info.val;
      }
    }

    function renderKip(){
      const cellPx = numVar("--cell") || 142;
      const baseLeft = 1 * cellPx;

      kipWrapper.innerHTML = "";

      for(let i = 0; i < 36; i++){
        const divCell = document.createElement("div");
        divCell.className = "kippCell";
        divCell.dataset.index = i;

        const val = kipAssignments[i];
        if(val !== null){
          divCell.classList.add("taken");
          const kipTgt = document.createElement("div");
          kipTgt.className = "kipTarget";
          if(targetRevealed){
            kipTgt.classList.add("revealed");
          }
          kipTgt.textContent = val;
          kipTgt.style.width = (cellPx) + "px";
          kipTgt.style.height = (cellPx) + "px";
          divCell.appendChild(kipTgt);
        } else {
          divCell.addEventListener("click", () => {
            if(uiMode !== "COUNT") return;
            placeAtIndex(i);
          });
        }

        kipWrapper.appendChild(divCell);
      }

      kipWrapper.style.left = baseLeft + "px";
    }

    function placeAtIndex(idx){
      if(kipAssignments[idx] !== null) return;

      for(const k of Object.keys(wFace)){
        if(kipAssignments[idx] === null){
          kipAssignments[idx] = wFace[k].val;
          break;
        }
      }

      renderKip();

      let placed = 0;
      for(const v of kipAssignments){
        if(v !== null) placed++;
      }

      if(placed >= 4){
        if(uiMode === "COUNT"){
          const t = pullTarget();
          if(t){
            currentTarget = t;
            attemptsForTarget = 0;
            showTargetView();
          } else {
            showEndView();
          }
        }
      }
    }

    function reroll12_keepAssigned(){
      const assigned = [...kipAssignments];
      const fresh = {4:4, 7:7, 1:1, 2:2};

      for(const v of assigned){
        if(v !== null){
          delete fresh[v];
        }
      }

      const remaining = Object.values(fresh);
      for(let i=0; i<remaining.length; i++){
        const j = i + roll(remaining.length - i);
        [remaining[i], remaining[j]] = [remaining[j], remaining[i]];
      }

      let ptr = 0;
      for(const k of Object.keys(wFace)){
        if(assigned.includes(wFace[k].val)){
          wFace[k].val = wFace[k].val;
        } else {
          wFace[k].val = remaining[ptr++];
        }
      }

      renderW();
    }

    function readKipFace(){
      const arr = [];
      for(let i=0; i<36; i++){
        if(kipAssignments[i] !== null){
          arr.push(kipAssignments[i]);
        }
      }
      return arr.join("");
    }

    function checkMatch(){
      const kip = readKipFace();
      if(kip === currentTarget){
        hitsCount++;
        updateScore();
        return true;
      }
      return false;
    }

    function resetTargetPadUI(){
      targetPadBtn.textContent = "?";
      targetRevealed = false;
    }

    function updateShadowVisibility(){
      const shadow = document.querySelector(".cubeShadowLayer");
      if(!shadow) return;

      const wVisible = !wFaceGroup.classList.contains("hidden");
      if(wVisible && !preview.interval){
        shadow.classList.add("visible");
      } else {
        shadow.classList.remove("visible");
      }

      const q0 = document.getElementById("shadowQ0");
      const q1 = document.getElementById("shadowQ1");
      const q2 = document.getElementById("shadowQ2");
      const q3 = document.getElementById("shadowQ3");

      q0.classList.remove("visible");
      q1.classList.remove("visible");
      q2.classList.remove("visible");
      q3.classList.remove("visible");

      if(preview.interval && preview.dir !== null){
        const dir = preview.dir;
        const quad = (dir - 1) % 4;
        if(quad === 0) q0.classList.add("visible");
        else if(quad === 1) q1.classList.add("visible");
        else if(quad === 2) q2.classList.add("visible");
        else if(quad === 3) q3.classList.add("visible");
      }
    }

    // Buttons
    kippAnzahlBtns.querySelectorAll(".btn").forEach(btn => {
      btn.addEventListener("click", () => {
        const val = parseInt(btn.dataset.anzahl);
        kippAnzahl = val;

        if(!started){
          startBtnWrap.classList.remove("hidden");
          started = true;
        } else {
          rotW(kippAnzahl);
        }
      });
    });

    btnErgebnis.addEventListener("click", () => {
      if(uiMode === "START"){
        rotW(kippAnzahl);
        showCountView();
      }
    });

    targetPadBtn.addEventListener("click", () => {
      if(!targetRevealed){
        targetPadBtn.textContent = currentTarget;
        targetRevealed = true;
        renderKip();
      } else {
        attemptsForTarget++;
        const match = checkMatch();

        if(match){
          resetTargetPadUI();
          lockColorsFromTarget();
          showStartView();
        } else {
          hintTitle.textContent = `FALSCH – Versuch ${attemptsForTarget}`;

          if(attemptsForTarget >= 2){
            resetTargetPadUI();
            showStartView();
          }
        }
      }
    });

    function lockColorsFromTarget(){
      if(!currentTarget) return;

      const digits = currentTarget.split("").map(d => parseInt(d));

      for(let i = 0; i < digits.length; i++){
        const val = digits[i];
        const wKey = Object.keys(wFace).find(k => wFace[k].val === val);
        if(!wKey) continue;

        const coord = wFace[wKey].coord;
        const colorCls = getColorForPosition(i);

        lockColorForVal[val] = colorCls;
        lockedPlacements.push([coord, colorCls]);
      }

      rebuildColors();
    }

    function getColorForPosition(idx){
      const map = {
        0: "c-gruen",
        1: "c-orange",
        2: "c-orange",
        3: "c-blau"
      };
      return map[idx] || "c-gruen";
    }

    testTargetBtn.addEventListener("click", () => {
      console.log("TEST => automatisch alle Zahlen platzieren");

      for(let i = 0; i < 36; i++){
        if(kipAssignments[i] === null){
          for(const k of Object.keys(wFace)){
            const val = wFace[k].val;
            const alreadyPlaced = kipAssignments.includes(val);
            if(!alreadyPlaced){
              kipAssignments[i] = val;
              break;
            }
          }
        }
      }

      renderKip();

      const t = pullTarget();
      if(t){
        currentTarget = t;
        attemptsForTarget = 0;
        showTargetView();
      } else {
        showEndView();
      }
    });

    backBtn.addEventListener("click", () => {
      if (uiMode === "START") {
        window.location.href = "index.html";
      } else {
        initPlayState();
      }
    });

    function setScaleToFitWidth(){
      const cols = numVar("--cols") || 8;
      const cell = numVar("--cell") || 142;

      const gridW = cols * cell;
      const vw = window.innerWidth;

      const targetW = vw * 0.94;
      const scale = Math.min(1, targetW / gridW);

      document.documentElement.style.setProperty("--scale", scale.toFixed(4));
      document.documentElement.style.setProperty("--gridW", gridW + "px");

      const uiscale = 1 / (scale || 1);
      document.documentElement.style.setProperty("--uiscale", uiscale.toFixed(4));

      return { cols, cell, gridW, scale };
    }

    function placeColorSquare(coord, cls, cellPx, sizePx){
      const { row, col } = coordToXY(coord);
      const visualRow = row + HEADER_ROW_OFFSET;

      const leftCell = (col - 1) * cellPx;
      const topCell  = (visualRow - 1) * cellPx;

      const pad = (cellPx - sizePx) / 2;
      const x = leftCell + pad;
      const y = topCell  + pad;

      const d = document.createElement("div");
      d.className = "colorSq " + cls;
      d.style.left = x + "px";
      d.style.top  = y + "px";
      colorsEl.appendChild(d);
    }

    function rebuildColors(){
      colorsEl.innerHTML = "";

      const cellPx = numVar("--cell") || 142;
      const sizePx = numVar("--colorSize") || 126;

      const placements = [
        ["1C","c-gruen"],  ["1D","c-orange"], ["1E","c-orange"], ["1F","c-blau"],
        ["8C","c-gruen"],  ["8D","c-violett"],["8E","c-violett"],["8F","c-blau"],
        ["3A","c-violett"],["4A","c-blau"],   ["5A","c-blau"],   ["6A","c-orange"],
        ["3H","c-violett"],["4H","c-gruen"],  ["5H","c-gruen"],  ["6H","c-orange"],
      ];

      for(const [coord, cls] of placements){
        placeColorSquare(coord, cls, cellPx, sizePx);
      }

      // Locked Colors hinzufügen
      for(const [coord, cls] of lockedPlacements){
        placeColorSquare(coord, cls, cellPx, sizePx);
      }
    }

    function positionScoreRun(cellPx){
      const run = document.getElementById("scoreRun");
      if(!run) return;

      const col = 8;
      const leftCell = (col - 1) * cellPx;
      const centerX = leftCell + (cellPx / 2);

      const headerY = 1.0 * cellPx;
      const centerY = headerY;

      run.style.left = centerX + "px";
      run.style.top  = centerY + "px";

      const fontSize = cellPx * 0.56;
      run.style.fontSize = fontSize + "px";
    }

    function positionScoreDisplay(cellPx){
      const score = document.getElementById("scoreDisplay");
      if(!score) return;

      const row = 6;
      const col = 4;
      const visualRow = row + HEADER_ROW_OFFSET;

      const leftCell = (col - 1) * cellPx;
      const topCell  = (visualRow - 1) * cellPx;

      const centerX = leftCell + (2 * cellPx) / 2;
      const centerY = topCell  + (cellPx) / 2;

      score.style.left = centerX + "px";
      score.style.top  = centerY + "px";

      const fontSize = cellPx * 0.96;
      score.style.fontSize = fontSize + "px";
    }

    function positionUI(){
      const cellPx = numVar("--cell") || 142;

      const headerY = 1.0 * cellPx;

      positionScoreRun(cellPx);
      positionScoreDisplay(cellPx);

      const title = document.getElementById("titleLeft");
      title.style.left = "50%";
      title.style.top = headerY + "px";
      title.style.transform = "translate(-50%, -50%)";

      const row11VisualTop = (((11 + HEADER_ROW_OFFSET) - 1) * cellPx);
      const row11CenterY   = row11VisualTop + (cellPx / 2);
      const between10and11 = row11VisualTop;

      const kippBtnsCenterY = between10and11;

      kippAnzahlBtns.style.top = kippBtnsCenterY + "px";
      kippAnzahlBtns.style.left = "50%";
      kippAnzahlBtns.style.transform = "translate(-50%, -50%)";

      const uiscale = numVar("--uiscale") || 1;
      const btnH = 44 * uiscale;
      startBtnWrap.style.top = (between10and11 - (btnH / 2)) + "px";

      if(uiMode === "TARGET"){
        hintTitle.style.top = row11CenterY + "px";
      } else if(uiMode === "START" || uiMode === "COUNT" || uiMode === "END"){
        const row9VisualTop  = (((9 + HEADER_ROW_OFFSET) - 1) * cellPx);
        const row10VisualTop = (((10 + HEADER_ROW_OFFSET) - 1) * cellPx);
        const midBetween9and10 = (row9VisualTop + row10VisualTop) / 2;
        hintTitle.style.top = (midBetween9and10 + 40) + "px";
      } else {
        hintTitle.style.top = row11CenterY + "px";
      }

      placeTargetPad_12D_13E(cellPx);
      positionBackButton(cellPx);
      positionTestButton(cellPx);
    }

    function positionBackButton(cellPx){
      const headerY = 1.0 * cellPx;
      const left = cellPx / 2;
      const top = headerY;

      backBtn.style.left = left + "px";
      backBtn.style.top = top + "px";
      backBtn.style.transform = "translate(-50%, -50%)";
    }

    function positionTestButton(cellPx){
      const row = 9;
      const col = 8;
      const visualRow = row + HEADER_ROW_OFFSET;

      const left = (col - 1) * cellPx + cellPx/2;
      const top  = (visualRow - 1) * cellPx + cellPx/2;

      testTargetBtn.style.position = "absolute";
      testTargetBtn.style.left = left + "px";
      testTargetBtn.style.top = top + "px";
      testTargetBtn.style.transform = "translate(-50%, -50%)";
      testTargetBtn.style.zIndex = "30";
      testTargetBtn.style.pointerEvents = "auto";
    }

    function placeTargetPad_12D_13E(cellPx){
      const row = 12;
      const col = 4;
      const visualRow = row + HEADER_ROW_OFFSET;

      const left = (col - 1) * cellPx;
      const top  = (visualRow - 1) * cellPx;

      targetPadBtn.style.left = left + "px";
      targetPadBtn.style.top  = top + "px";
      targetPadBtn.style.width  = (2 * cellPx) + "px";
      targetPadBtn.style.height = (2 * cellPx) + "px";
    }

    function rebuild(){
      const { cell, scale } = setScaleToFitWidth();
      const vh = window.innerHeight;
      const effectiveLayoutHeight = vh / scale;
      const rows = Math.ceil(effectiveLayoutHeight / cell) + 1;
      const gridH = rows * cell;
      document.documentElement.style.setProperty("--gridH", gridH + "px");

      rebuildColors();
      positionUI();
      updateShadowVisibility();

      if(!wFaceGroup.classList.contains("hidden")) renderW();
      else renderKip();
    }

    function initPlayState(){
      cancelPreview();

      resetTargetDeck();
      currentTarget = null;
      targetRevealed = false;
      started = false;
      attemptsForTarget = 0;

      resetLockedColors();
      hitsCount = 0;
      updateScore();

      endRestartMode = false;
      const scoreEl = document.getElementById("scoreDisplay");
      if(scoreEl){
        scoreEl.classList.remove("finalVisible", "scorePulse");
        scoreEl.style.removeProperty("opacity");
      }

      resetTargetPadUI();

      reroll12_keepAssigned();
      showW();
      renderW();

      btnErgebnis.onclick = null;

      showStartView();
      updateShadowVisibility();
    }

    window.addEventListener("load", () => {
      rebuild();
      initPlayState();
    });

    window.addEventListener("resize", rebuild);

    document.addEventListener("touchmove", (e) => {
      const inRange = e.target && e.target.closest && e.target.closest('input[type="range"]');
      if(inRange) return;
      e.preventDefault();
    }, { passive:false });

    // Intro Overlay Handler
    const introOverlay = document.getElementById("introOverlay");
    const introStartBtn = document.getElementById("introStartBtn");
    const introBackBtn = document.getElementById("introBackBtn");

    introStartBtn.addEventListener("click", () => {
      introOverlay.classList.add("hidden");
      setTimeout(() => {
        introOverlay.remove();
      }, 400);
    });

    introBackBtn.addEventListener("click", () => {
      window.location.href = "index.html";
    });
  </script>
</body>
</html>
